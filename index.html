<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Car Controller</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        button { font-size: 20px; padding: 10px; margin: 10px; width: 100px; }
        input { width: 80%; }
        #joystick-container { width: 150px; height: 150px; background: lightgray; border-radius: 50%; position: relative; margin: auto; }
        #joystick { width: 50px; height: 50px; background: black; border-radius: 50%; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body>
    <h1>ESP32 Car Controller</h1>
    <p>Use the joystick or Xbox controller to drive the car.</p>

    <button onclick="connectToESP32()">Connect to ESP32</button>

    <br><br>
    <label>Throttle: <span id="throttleValue">0</span>%</label>
    <input type="range" id="throttle" min="0" max="100" step="1" oninput="sendThrottle(this.value)">

    <br><br>
    <div id="joystick-container">
        <div id="joystick"></div>
    </div>
    <p>Steering: <span id="steeringValue">50</span>%</p>

    <br><br>
    <button onclick="sendSteer(25)">â¬… Left</button>
    <button onclick="sendSteer(75)">Right âž¡</button>

    <p id="xboxStatus">ðŸŽ® Xbox Controller: Not Connected</p>

    <!-- Engine Sound Files -->
    <audio id="idle" src="https://JMckenzie08.github.io/esp32-car-control/idle.mp3" preload="auto" loop></audio>
    <audio id="rev" src="https://JMckenzie08.github.io/esp32-car-control/rev.mp3" preload="auto" loop></audio>
    <audio id="max" src="https://JMckenzie08.github.io/esp32-car-control/max_rpm.mp3" preload="auto" loop></audio>

    <script>
        let esp32IP = "http://192.168.4.1"; // Change this if ESP32 is in home Wi-Fi mode
        let xboxConnected = false;

        async function connectToESP32() {
            alert("Ensure your phone is connected to ESP32's Wi-Fi, then use this page.");
        }

        async function sendThrottle(value) {
            document.getElementById("throttleValue").innerText = value;
            fetch(esp32IP + "/throttle?value=" + value);
            updateEngineSound(value);
        }

        async function sendSteer(value) {
            document.getElementById("steeringValue").innerText = value;
            fetch(esp32IP + "/steer?value=" + value);
        }

        function updateEngineSound(throttle) {
            document.getElementById("idle").pause();
            document.getElementById("rev").pause();
            document.getElementById("max").pause();

            if (throttle == 0) {
                document.getElementById("idle").play();
            } else if (throttle < 50) {
                document.getElementById("rev").play();
            } else {
                document.getElementById("max").play();
            }
        }

        // ðŸŽ® Xbox Controller Support
        window.addEventListener("gamepadconnected", (event) => {
            xboxConnected = true;
            document.getElementById("xboxStatus").innerText = "ðŸŽ® Xbox Controller: Connected!";
            gameLoop();
        });

        function gameLoop() {
            if (!xboxConnected) return;
            let gamepad = navigator.getGamepads()[0];
            if (gamepad) {
                let throttleValue = Math.round((gamepad.buttons[7].value) * 100); // RT for throttle
                let steerValue = Math.round((gamepad.axes[0] + 1) * 50); // Left joystick X-axis for steering
                
                sendThrottle(throttleValue);
                sendSteer(steerValue);
            }
            requestAnimationFrame(gameLoop);
        }

        // ðŸ•¹ Joystick Movement
        let joystick = document.getElementById("joystick");
        let container = document.getElementById("joystick-container");

        let containerRect = container.getBoundingClientRect();
        let centerX = containerRect.left + containerRect.width / 2;
        let centerY = containerRect.top + containerRect.height / 2;

        container.addEventListener("touchmove", function(event) {
            let touch = event.touches[0];
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            let distance = Math.sqrt(dx * dx + dy * dy);
            let maxDistance = container.offsetWidth / 2;

            if (distance > maxDistance) {
                dx = (dx / distance) * maxDistance;
                dy = (dy / distance) * maxDistance;
            }

            joystick.style.transform = `translate(${dx}px, ${dy}px)`;

            let steerValue = Math.round(((dx / maxDistance) + 1) * 50);
            sendSteer(steerValue);
        });

        container.addEventListener("touchend", function() {
            joystick.style.transform = "translate(-50%, -50%)";
            sendSteer(50);
        });

    </script>
</body>
</html>
