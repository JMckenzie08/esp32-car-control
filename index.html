<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Car Controller</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; overflow: hidden; }
        button { font-size: 20px; padding: 10px; margin: 10px; width: 150px; }
        input { width: 80%; }
    </style>
</head>
<body>
    <h1>ESP32 Car Controller</h1>
    <p>Use the throttle & steering sliders or Xbox controller to drive the car.</p>

    <button onclick="startEngine()">Start Engine</button>
    <button onclick="connectToESP32()">Connect to ESP32</button>

    <br><br>
    <label>Throttle: <span id="throttleValue">0</span>%</label>
    <input type="range" id="throttle" min="0" max="100" step="1" oninput="updateThrottle(this.value)">

    <br><br>
    <label>Steering: <span id="steeringValue">50</span>%</label>
    <input type="range" id="steering" min="0" max="100" step="1" oninput="updateSteering(this.value)">

    <p id="xboxStatus">ðŸŽ® Xbox Controller: Not Connected</p>

    <script>
        let esp32IP = "http://192.168.4.1"; 
        let audioContext, engineSound, idleSound, revSound, limiterSound, shiftUpSound, shiftDownSound, coastSound;
        let lastThrottle = 0;
        let lastGear = 1;

        async function startEngine() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Load Engine Sounds
                engineSound = await loadSound("https://jmckenzie08.github.io/esp32-car-control/sounds/engine_loop.wav");
                idleSound = await loadSound("https://jmckenzie08.github.io/esp32-car-control/sounds/idle.wav");
                revSound = await loadSound("https://jmckenzie08.github.io/esp32-car-control/sounds/rev.wav");
                limiterSound = await loadSound("https://jmckenzie08.github.io/esp32-car-control/sounds/limiter.wav");
                shiftUpSound = await loadSound("https://jmckenzie08.github.io/esp32-car-control/sounds/upshift.wav");
                shiftDownSound = await loadSound("https://jmckenzie08.github.io/esp32-car-control/sounds/downshift.wav");
                coastSound = await loadSound("https://jmckenzie08.github.io/esp32-car-control/sounds/coast.wav");

                // Start Idle Sound
                idleSound.loop = true;
                idleSound.start(0);
            }
            alert("Engine sound started! Move throttle to change RPM.");
        }

        async function loadSound(url) {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            return source;
        }

        function updateThrottle(value) {
            document.getElementById("throttleValue").innerText = value;
            document.getElementById("throttle").value = value;
            fetch(esp32IP + "/throttle?value=" + value);

            if (value > 0) {
                idleSound.stop();
                engineSound.loop = true;
                engineSound.play();
                let playbackRate = 0.5 + (value / 100) * 1.5;
                engineSound.playbackRate.value = playbackRate;

                if (value > lastThrottle + 10) {
                    revSound.play();
                }
            } else {
                engineSound.stop();
                idleSound.loop = true;
                idleSound.play();
                coastSound.play(); // Play coasting sound when letting off throttle
            }

            if (value === 100) {
                limiterSound.play();
            }

            lastThrottle = value;
        }

        function shiftGear(newGear) {
            if (newGear !== lastGear) {
                if (newGear > lastGear) {
                    shiftUpSound.play(); // Play upshift sound
                } else {
                    shiftDownSound.play(); // Play downshift sound
                }
                lastGear = newGear;
            }
        }

        // ðŸŽ® Xbox Controller Support
        window.addEventListener("gamepadconnected", () => {
            xboxConnected = true;
            document.getElementById("xboxStatus").innerText = "ðŸŽ® Xbox Controller: Connected!";
            requestAnimationFrame(gameLoop);
        });

        function gameLoop() {
            let gamepad = navigator.getGamepads()[0];
            if (gamepad) {
                let throttleValue = Math.round((gamepad.buttons[7].value) * 100);
                let steerValue = Math.round((gamepad.axes[0] + 1) * 50);

                if (throttleValue !== lastThrottle) {
                    updateThrottle(throttleValue);
                }

                if (gamepad.buttons[12].pressed) {
                    shiftGear(lastGear + 1);
                }
                if (gamepad.buttons[13].pressed) {
                    shiftGear(lastGear - 1);
                }
            }
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
