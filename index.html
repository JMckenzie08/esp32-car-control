<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Car Controller</title>

    <!-- Add dat.GUI for Engine Stats -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>

    <style>
        body { text-align: center; font-family: Arial, sans-serif; overflow: hidden; }
        button { font-size: 20px; padding: 10px; margin: 10px; width: 150px; }
        input { width: 80%; }
    </style>

    <!-- Load External JavaScript Files -->
    <script src="https://jmckenzie08.github.io/esp32-car-control/js/AudioManager.js"></script>
    <script src="https://jmckenzie08.github.io/esp32-car-control/js/Engine.js"></script>
    <script src="https://jmckenzie08.github.io/esp32-car-control/js/Drivetrain.js"></script>
    <script src="https://jmckenzie08.github.io/esp32-car-control/js/main.js"></script>

</head>
<body>
    <h1>ESP32 Car Controller</h1>
    <p>Use the throttle & steering sliders or Xbox controller to drive the car.</p>

    <button onclick="startEngine()">Start Engine</button>
    <button onclick="connectToESP32()">Connect to ESP32</button>

    <br><br>
    <label>Throttle: <span id="throttleValue">0</span>%</label>
    <input type="range" id="throttle" min="0" max="100" step="1" oninput="updateThrottle(this.value)">

    <br><br>
    <label>Steering: <span id="steeringValue">50</span>%</label>
    <input type="range" id="steering" min="0" max="100" step="1" oninput="updateSteering(this.value)">

    <p id="xboxStatus">ðŸŽ® Xbox Controller: Not Connected</p>

    <script>
        let esp32IP = "http://192.168.4.1"; 
        let audioManager = new AudioManager();
        let engine = new Engine();
        let drivetrain = new Drivetrain();

        async function startEngine() {
            await audioManager.init({
                lowRPM: "https://jmckenzie08.github.io/esp32-car-control/sounds/BAC_Mono_offlow.wav",
                midRPM: "https://jmckenzie08.github.io/esp32-car-control/sounds/BAC_Mono_onmid.wav",
                highRPM: "https://jmckenzie08.github.io/esp32-car-control/sounds/BAC_Mono_offhigh.wav",
                revving: "https://jmckenzie08.github.io/esp32-car-control/sounds/REV.wav",
                limiter: "https://jmckenzie08.github.io/esp32-car-control/sounds/limiter.wav"
            });
            audioManager.play("lowRPM");
        }

        function updateThrottle(value) {
            document.getElementById("throttleValue").innerText = value;
            engine.updateThrottle(value);

            if (value > 80) {
                audioManager.play("highRPM");
            } else if (value > 30) {
                audioManager.play("midRPM");
            } else {
                audioManager.play("lowRPM");
            }

            fetch(esp32IP + "/throttle?value=" + value);
        }

        function updateSteering(value) {
            document.getElementById("steeringValue").innerText = value;
            fetch(esp32IP + "/steer?value=" + value);
        }

        // ðŸŽ® Xbox Controller Support
        window.addEventListener("gamepadconnected", () => {
            document.getElementById("xboxStatus").innerText = "ðŸŽ® Xbox Controller: Connected!";
            requestAnimationFrame(gameLoop);
        });

        function gameLoop() {
            let gamepad = navigator.getGamepads()[0];
            if (gamepad) {
                let throttleValue = Math.round((gamepad.buttons[7].value) * 100);
                updateThrottle(throttleValue);
            }
            requestAnimationFrame(gameLoop);
        }

        // ðŸ“Š Engine Stats GUI
        let gui = new dat.GUI();
        let engineStats = {
            rpm: engine.rpm,
            gear: drivetrain.currentGear,
            throttle: 0
        };

        gui.add(engineStats, 'rpm').listen();
        gui.add(engineStats, 'gear').listen();
        gui.add(engineStats, 'throttle').listen();
    </script>
</body>
</html>
